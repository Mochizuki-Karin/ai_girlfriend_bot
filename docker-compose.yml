version: '3.8'

services:
  # AI女友ロボットメインサービス
  ai-girlfriend-bot:
    build: .
    container_name: ai-girlfriend-bot
    restart: unless-stopped
    
    environment:
      # Telegram Bot Token (必須)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      
      # LLM設定
      - DEFAULT_LLM_PROVIDER=${DEFAULT_LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_MODEL=${GOOGLE_MODEL:-gemini-pro}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-sonnet-20240229}
      - LOCAL_MODEL_URL=${LOCAL_MODEL_URL:-http://localhost:11434}
      - LOCAL_MODEL_NAME=${LOCAL_MODEL_NAME:-llama2-chinese}
      
      # データベース設定
      - DATABASE_URL=${DATABASE_URL:-sqlite:///data/bot_memory.db}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - USE_REDIS=${USE_REDIS:-false}
      - CHROMA_PERSIST_DIR=/app/data/chroma
      
      # キャラクター設定
      - PERSONA_CONFIG_PATH=/app/config/persona_default.yaml
      
      # 機能スイッチ
      - AFFECTION_ENABLED=${AFFECTION_ENABLED:-true}
      - MEMORY_ENABLED=${MEMORY_ENABLED:-true}
      - INITIATIVE_ENABLED=${INITIATIVE_ENABLED:-true}
      - LEARNING_ENABLED=${LEARNING_ENABLED:-true}
      
      # ログ
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TIMEZONE=${TIMEZONE:-Asia/Shanghai}
      
      # 管理者
      - ADMIN_USER_IDS=${ADMIN_USER_IDS}
    
    volumes:
      # データ永続化
      - ./data:/app/data
      - ./logs:/app/logs
      # キャラクター設定（カスタマイズ可）
      - ./config:/app/config
    
    networks:
      - ai-gf-network
    
    depends_on:
      - redis
      - chroma
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redisキャッシュサービス（オプション）
  redis:
    image: redis:7-alpine
    container_name: ai-gf-redis
    restart: unless-stopped
    
    volumes:
      - redis-data:/data
    
    networks:
      - ai-gf-network
    
    # USE_REDIS=trueの場合のみ起動
    profiles:
      - with-redis

  # ChromaDBベクターデータベースサービス
  chroma:
    image: chromadb/chroma:latest
    container_name: ai-gf-chroma
    restart: unless-stopped
    
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    
    volumes:
      - chroma-data:/chroma/chroma
    
    networks:
      - ai-gf-network
    
    ports:
      - "8000:8000"  # ChromaDBへの外部アクセス用

  # ローカルモデルサービス（Ollama）（オプション）
  ollama:
    image: ollama/ollama:latest
    container_name: ai-gf-ollama
    restart: unless-stopped
    
    volumes:
      - ollama-data:/root/.ollama
    
    networks:
      - ai-gf-network
    
    # GPUサポート（NVIDIA Dockerランタイムが必要）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    profiles:
      - with-ollama

  # Web管理インターフェース（オプション）
  admin:
    build:
      context: .
      dockerfile: Dockerfile.admin
    container_name: ai-gf-admin
    restart: unless-stopped
    
    environment:
      - BOT_DATA_PATH=/app/data
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}
    
    volumes:
      - ./data:/app/data:ro
    
    ports:
      - "8080:8080"
    
    networks:
      - ai-gf-network
    
    profiles:
      - with-admin

volumes:
  redis-data:
  chroma-data:
  ollama-data:

networks:
  ai-gf-network:
    driver: bridge
